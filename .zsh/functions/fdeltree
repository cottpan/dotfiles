#!/usr/bin/env zsh
#
# fdeltree - Git Worktree Deletion with fzf
#
# Description:
#   git worktree „Çí fzf „ÅßÈÅ∏Êäû„Åó„Å¶ÂâäÈô§
#   worktree ÂâäÈô§Âæå„ÄÅÈñ¢ÈÄ£„Åô„Çã„Éñ„É©„É≥„ÉÅ„ÇÇÂâäÈô§„Åô„Çã„ÅãÈÅ∏ÊäûÂèØËÉΩ
#
# Features:
#   - worktree „ÅÆ„Éñ„É©„É≥„ÉÅÂêç„ÄÅÂ§âÊõ¥„Éï„Ç°„Ç§„É´„ÄÅ„Ç≥„Éü„ÉÉ„ÉàÂ±•Ê≠¥„Çí„Éó„É¨„Éì„É•„Éº
#   - Êú™„Ç≥„Éü„ÉÉ„Éà„ÅÆÂ§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
#   - „É°„Ç§„É≥ worktree „ÅÆÂâäÈô§„ÅØ‰∏çÂèØ
#   - „Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÂâäÈô§ÂØæË±°„ÅÆÂ†¥Âêà„ÅØ„Ç®„É©„Éº
#
# Usage:
#   fdeltree
#
fdeltree() {
  # Check if we're in a git repository
  if ! git rev-parse --git-dir &> /dev/null; then
    echo "‚ùå Not in a git repository"
    return 1
  fi

  # Get worktree list
  local worktrees selected_worktree worktree_path current_path is_main_worktree

  # Get current working directory
  current_path=$(pwd)
  
  # Format of `git worktree list`: path commit [branch]
  worktrees=$(git worktree list)
  
  if [ -z "$worktrees" ]; then
    echo "üì≠ No worktrees found"
    return 0
  fi

  # Select worktree to delete
  selected_worktree=$(echo "$worktrees" | fzf \
    --prompt="worktrees to delete > " \
    --header="‚ö†Ô∏è  Select a worktree to DELETE (main worktree cannot be deleted)" \
    --preview="echo 'üì¶ Branch:' && git -C {1} branch --show-current && echo '' && echo 'üìù Changed files:' && git -C {1} status --porcelain | head -10 && echo '' && echo 'üìö Recent commits:' && git -C {1} log --oneline --decorate -5" \
    --preview-window="right:50%" \
    --reverse \
    --border \
    --ansi)

  if [ $? -ne 0 ]; then
    return 0
  fi

  if [ -n "$selected_worktree" ]; then
    # Extract worktree path
    worktree_path=${${(s: :)selected_worktree}[1]}
    
    # Check if it's the main worktree (usually contains .git directory, not .git file)
    if [ -d "${worktree_path}/.git" ]; then
      echo "‚ùå Cannot delete main worktree: $worktree_path"
      return 1
    fi

    # Check if we're currently in the worktree that's about to be deleted
    if [[ "$current_path" == "$worktree_path"* ]]; then
      echo "‚ö†Ô∏è  You are currently in the worktree that will be deleted."
      echo "   Current path: $current_path"
      echo "   Worktree path: $worktree_path"
      echo ""
      echo "Please navigate to a different directory first, then run this command again."
      return 1
    fi

    # Get branch name before deletion
    local branch_name=$(git -C "$worktree_path" branch --show-current 2>/dev/null)
    
    # Show worktree details
    echo "üóÇÔ∏è  Worktree to delete:"
    echo "   Path: $worktree_path"
    echo "   Branch: ${branch_name:-N/A}"
    echo ""
    
    # Check for uncommitted changes
    local status_output=$(git -C "$worktree_path" status --porcelain 2>/dev/null)
    if [ -n "$status_output" ]; then
      echo "‚ö†Ô∏è  WARNING: This worktree has uncommitted changes:"
      echo "$status_output" | head -5
      echo ""
    fi

    # Confirmation prompt
    echo "‚ùì Are you sure you want to delete this worktree? [y/N]:"
    read -q confirmation
    echo ""

    if [[ "$confirmation" != "y" ]]; then
      echo "üö´ Deletion cancelled"
      return 0
    fi

    # Delete the worktree
    if git worktree remove "$worktree_path" --force; then
      echo "‚úÖ Worktree deleted successfully: $worktree_path"
      
      # Ask if user wants to delete the branch too
      if [ -n "$branch_name" ]; then
        echo ""
        echo "üåø Delete branch '$branch_name' too? [y/N]:"
        read -q delete_branch
        echo ""
        
        if [[ "$delete_branch" == "y" ]]; then
          if git branch -D "$branch_name"; then
            echo "‚úÖ Branch '$branch_name' deleted successfully"
          else
            echo "‚ùå Failed to delete branch '$branch_name'"
            echo "   The branch might be checked out in another worktree or might not exist"
          fi
        else
          echo "üîñ Branch '$branch_name' kept"
        fi
      fi
    else
      echo "‚ùå Failed to delete worktree: $worktree_path"
      echo "   You may need to delete it manually or use --force flag"
      return 1
    fi
  fi

  # Only clear screen if ZLE is active
  if zle; then
    zle clear-screen
  fi
}

