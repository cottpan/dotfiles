#!/usr/bin/env zsh
#
# fnewtree - Create New Branch and Worktree
#
# Description:
#   æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã¨ worktree ã‚’åŒæ™‚ã«ä½œæˆ
#   ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’ fzf ã§é¸æŠã—ã€æ–°è¦ãƒ–ãƒ©ãƒ³ãƒåã‚’å…¥åŠ›ã—ã¦ä½œæˆ
#   ä½œæˆå ´æ‰€: <è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>/<ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå>.worktree/<æ–°ãƒ–ãƒ©ãƒ³ãƒå>
#
# Features:
#   - ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
#   - ãƒ–ãƒ©ãƒ³ãƒåã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
#   - worktree ãƒ‘ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½
#   - VSCode ã§ã®è‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
#
# Usage:
#   fnewtree
#
# Example:
#   fnewtree
#   > ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒé¸æŠ (ä¾‹: main)
#   > æ–°ãƒ–ãƒ©ãƒ³ãƒåå…¥åŠ› (ä¾‹: feat/new-feature)
#   â†’ ~/src/project.worktree/feat/new-feature ãŒä½œæˆã•ã‚Œã‚‹
#
fnewtree() {
  # Check if we're in a git repository
  if ! git rev-parse --git-dir &> /dev/null; then
    echo "âŒ Not in a git repository"
    return 1
  fi

  local branches base_branch selected_base new_branch_name worktree_path
  
  # Get all branches (local and remote, excluding HEAD)
  branches=$(git branch --all | grep -v HEAD)
  
  # Select base branch using fzf
  echo "ğŸŒ¿ Select base branch to create new branch from:"
  base_branch=$(echo "$branches" |
    fzf --prompt="base branch > " \
        --header="Select a base branch for the new branch" \
        --preview="echo 'ğŸ“¦ Branch info:' && git log --oneline --decorate -10 \$(echo {} | sed 's/.* //' | sed 's#remotes/[^/]*/##')" \
        --preview-window="right:50%" \
        --reverse \
        --border \
        --ansi)

  if [ $? -ne 0 ]; then
    return 0
  fi

  if [ -z "$base_branch" ]; then
    echo "âŒ No base branch selected"
    return 1
  fi

  # Extract raw branch reference (preserve full remote path)
  selected_base=$(echo "$base_branch" | sed "s/.* //")
  
  # Ask for new branch name
  echo ""
  echo "ğŸ·ï¸  Enter new branch name:"
  read new_branch_name
  
  if [ -z "$new_branch_name" ]; then
    echo "âŒ Branch name cannot be empty"
    return 1
  fi

  # Check if branch already exists
  if git show-ref --verify --quiet "refs/heads/$new_branch_name"; then
    echo "âŒ Branch '$new_branch_name' already exists"
    return 1
  fi

  # Get current project directory name and parent directory
  local git_root=$(git rev-parse --show-toplevel)
  local current_dir=$(basename "$git_root")
  local parent_dir=$(dirname "$git_root")
  local worktree_base_dir="${parent_dir}/${current_dir}.worktree"
  local default_path="${worktree_base_dir}/${new_branch_name}"
  
  # Ask for worktree path
  echo ""
  echo "ğŸ“ Enter worktree path (default: ${default_path}):"
  read worktree_path
  
  # Use default if empty
  if [ -z "$worktree_path" ]; then
    worktree_path="$default_path"
  fi

  # Create worktree base directory if it doesn't exist
  local worktree_dir=$(dirname "$worktree_path")
  if [ ! -d "$worktree_dir" ]; then
    echo "ğŸ“ Creating worktree directory: $worktree_dir"
    mkdir -p "$worktree_dir"
  fi

  # Check if worktree path already exists
  if [ -e "$worktree_path" ]; then
    echo "âŒ Path already exists: $worktree_path"
    return 1
  fi

  # Create the worktree with new branch
  echo ""
  echo "ğŸŒ¿ Creating new branch '$new_branch_name' from '$selected_base'..."
  echo "ğŸ“¦ Creating worktree at: $worktree_path"
  
  if git worktree add -b "$new_branch_name" "$worktree_path" "$selected_base"; then
    echo "âœ… Branch and worktree created successfully!"
    echo "   Branch: $new_branch_name"
    echo "   Path: $worktree_path"
    
    # Ask if user wants to open with VSCode
    echo ""
    echo "ğŸ’» Open with VSCode? [y/N]:"
    read -q open_vscode
    echo ""
    
    local should_cd=true
    if [[ "$open_vscode" == "y" ]]; then
      if command -v code &> /dev/null; then
        echo "ğŸš€ Opening VSCode..."
        code "$worktree_path"
        should_cd=false
      else
        echo "âŒ VSCode (code command) not found"
      fi
    fi
    
    # Navigate to the new worktree only if VSCode was not opened
    if [[ "$should_cd" == true ]]; then
      if zle; then
        # Called from ZLE (keyboard shortcut)
        BUFFER="cd ${worktree_path}"
        zle accept-line
      else
        # Called directly from command line
        cd "$worktree_path"
      fi
    fi
  else
    echo "âŒ Failed to create branch and worktree"
    return 1
  fi

  # Only clear screen if ZLE is active
  if zle; then
    zle clear-screen
  fi
}


