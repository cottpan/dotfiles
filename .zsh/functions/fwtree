#!/usr/bin/env zsh
#
# fwtree - Git Worktree Navigator with fzf
#
# Description:
#   Êó¢Â≠ò„ÅÆ git worktree „Çí fzf „ÅßÈÅ∏Êäû„Åó„Å¶„Éá„Ç£„É¨„ÇØ„Éà„É™ÁßªÂãï
#   ÂêÑ worktree „ÅÆ„Éñ„É©„É≥„ÉÅÂêç„ÄÅÂ§âÊõ¥„Éï„Ç°„Ç§„É´„ÄÅ„Ç≥„Éü„ÉÉ„ÉàÂ±•Ê≠¥„Çí„Éó„É¨„Éì„É•„ÉºË°®Á§∫
#
# Usage:
#   fwtree
#
fwtree() {
  # Format of `git worktree list`: path commit [branch]
  local selected_worktree=$(git worktree list | fzf \
    --prompt="worktrees > " \
    --header="Select a worktree to cd into" \
    --preview="echo 'üì¶ Branch:' && git -C {1} branch --show-current && echo '' && echo 'üìù Changed files:' && git -C {1} status --porcelain | head -10 && echo '' && echo 'üìö Recent commits:' && git -C {1} log --oneline --decorate -10" \
    --preview-window="right:40%" \
    --reverse \
    --border \
    --ansi)

  if [ $? -ne 0 ]; then
    return 0
  fi

  if [ -n "$selected_worktree" ]; then
    local selected_path=${${(s: :)selected_worktree}[1]}

    if [ -d "$selected_path" ]; then
      if zle; then
        # Called from ZLE (keyboard shortcut)
        BUFFER="cd ${selected_path}"
        zle accept-line
      else
        # Called directly from command line
        cd "$selected_path"
      fi
    else
      echo "Directory not found: $selected_path"
      return 1
    fi
  fi

  # Only clear screen if ZLE is active
  if zle; then
    zle clear-screen
  fi
}

