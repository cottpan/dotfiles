#!/usr/bin/env zsh
#
# fbrwtree - Git Worktree Creation from Existing Branch
#
# Description:
#   æ—¢å­˜ã® git ãƒ–ãƒ©ãƒ³ãƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ»ãƒªãƒ¢ãƒ¼ãƒˆï¼‰ã‚’ fzf ã§é¸æŠã—ã¦ worktree ã‚’ä½œæˆ
#   ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯è‡ªå‹•çš„ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
#   ä½œæˆå ´æ‰€: <è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>/<ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå>.worktree/<ãƒ–ãƒ©ãƒ³ãƒå>
#   
# Features:
#   - ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
#   - worktree ãƒ‘ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½
#   - VSCode ã§ã®è‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
#
# Usage:
#   fbrwtree
#
fbrwtree() {
  local branches branch selected_branch worktree_path
  
  # Get all branches (local and remote, excluding HEAD)
  branches=$(git branch --all | grep -v HEAD) &&
  
  # Select branch using fzf
  branch=$(echo "$branches" |
    fzf --prompt="branches > " \
        --header="Select a branch to create worktree" \
        --preview="echo 'ğŸ“¦ Branch info:' && git log --oneline --decorate -10 \$(echo {} | sed 's/.* //' | sed 's#remotes/[^/]*/##')" \
        --preview-window="right:50%" \
        --reverse \
        --border \
        --ansi)

  if [ $? -ne 0 ]; then
    return 0
  fi

  if [ -n "$branch" ]; then
    # Extract raw branch reference (preserve full remote path)
    local branch_ref=$(echo "$branch" | sed "s/.* //")
    
    # Clean branch name for directory naming (remove prefix markers and remote path)
    selected_branch=$(echo "$branch_ref" | sed "s#remotes/[^/]*/##")
    
    # Get current project directory name and parent directory
    local git_root=$(git rev-parse --show-toplevel)
    local current_dir=$(basename "$git_root")
    local parent_dir=$(dirname "$git_root")
    local worktree_base_dir="${parent_dir}/${current_dir}.worktree"
    local default_path="${worktree_base_dir}/${selected_branch}"
    
    # Ask for worktree path
    echo "Enter worktree path (default: ${default_path}):"
    read worktree_path
    
    # Use default if empty
    if [ -z "$worktree_path" ]; then
      worktree_path="$default_path"
    fi

    # Create worktree base directory if it doesn't exist
    local worktree_dir=$(dirname "$worktree_path")
    if [ ! -d "$worktree_dir" ]; then
      echo "ğŸ“ Creating worktree directory: $worktree_dir"
      mkdir -p "$worktree_dir"
    fi

    # Determine if it's a remote branch and needs local branch creation
    local local_branch_name="$selected_branch"
    
    if [[ "$branch_ref" =~ ^remotes/ ]]; then
      # Remote branch: need to create a local branch
      if git show-ref --verify --quiet "refs/heads/$local_branch_name"; then
        echo "ğŸ“Œ Local branch '$local_branch_name' already exists, using it"
        git worktree add "$worktree_path" "$local_branch_name"
      else
        echo "ğŸŒ¿ Creating local branch '$local_branch_name' from '$branch_ref'"
        git worktree add -b "$local_branch_name" "$worktree_path" "$branch_ref"
      fi
    else
      # Local branch: use directly
      echo "ğŸ“¦ Creating worktree from local branch: $branch_ref"
      git worktree add "$worktree_path" "$branch_ref"
    fi
    
    if [ $? -eq 0 ]; then
      echo "âœ… Worktree created successfully: $worktree_path"
      
      # Copy .env and .mise.local.toml files from main repository
      local git_root=$(git rev-parse --show-toplevel)
      local config_files=$(find "$git_root" -maxdepth 3 \( -name ".env*" -o -name ".mise.local.toml" \) -type f 2>/dev/null)
      
      if [ -n "$config_files" ]; then
        echo ""
        echo "ğŸ“„ Found config files in main repository:"
        echo "$config_files" | while read config_file; do
          local rel_path=${config_file#$git_root/}
          echo "   $rel_path"
        done
        echo ""
        echo "ğŸ“‹ Copy config files to new worktree? [y/N]:"
        read -q copy_config
        echo ""
        
        if [[ "$copy_config" == "y" ]]; then
          echo "$config_files" | while read config_file; do
            local rel_path=${config_file#$git_root/}
            local target_file="$worktree_path/$rel_path"
            local target_dir=$(dirname "$target_file")
            
            # Create directory if it doesn't exist
            if [ ! -d "$target_dir" ]; then
              mkdir -p "$target_dir"
            fi
            
            # Copy file
            if cp "$config_file" "$target_file"; then
              echo "   âœ… Copied: $rel_path"
            else
              echo "   âŒ Failed to copy: $rel_path"
            fi
          done
        else
          echo "â­ï¸  Skipped copying config files"
        fi
      fi
      
      # Ask if user wants to open with VSCode
      echo "ğŸ’» Open with VSCode? [y/N]:"
      read -q open_vscode
      echo ""
      
      local should_cd=true
      if [[ "$open_vscode" == "y" ]]; then
        if command -v code &> /dev/null; then
          echo "ğŸš€ Opening VSCode..."
          code "$worktree_path"
          should_cd=false
        else
          echo "âŒ VSCode (code command) not found"
        fi
      fi
      
      # Navigate to the new worktree only if VSCode was not opened
      if [[ "$should_cd" == true ]]; then
        if zle; then
          # Called from ZLE (keyboard shortcut)
          BUFFER="cd ${worktree_path}"
          zle accept-line
        else
          # Called directly from command line
          cd "$worktree_path"
        fi
      fi
    else
      echo "âŒ Failed to create worktree"
      return 1
    fi
  fi

  # Only clear screen if ZLE is active
  if zle; then
    zle clear-screen
  fi
}

