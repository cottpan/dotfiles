#!/usr/bin/env zsh
#
# fprwtree - Git Worktree Creation from Pull Request
#
# Description:
#   GitHub ã® Pull Request ã‚’ fzf ã§é¸æŠã—ã¦ worktree ã‚’ä½œæˆ
#   Fork ã‹ã‚‰ã® PR ã«ã‚‚å¯¾å¿œï¼ˆè‡ªå‹•çš„ã«ãƒªãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ï¼‰
#   ä½œæˆå ´æ‰€: <è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>/<ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå>.worktree/pr-<ç•ªå·>-<ãƒ–ãƒ©ãƒ³ãƒå>
#
# Features:
#   - PR ã®ã‚¿ã‚¤ãƒˆãƒ«ã€ä½œè€…ã€èª¬æ˜ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
#   - Fork PR ã®å ´åˆã¯è‡ªå‹•çš„ã«ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ 
#   - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’è‡ªå‹•ä½œæˆï¼ˆdetached HEAD ã«ãªã‚‰ãªã„ï¼‰
#   - worktree ãƒ‘ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½
#   - VSCode ã§ã®è‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
#
# Requirements:
#   - GitHub CLI (gh) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦
#
# Usage:
#   fprwtree
#
fprwtree() {
  # Check if gh command is available
  if ! command -v gh &> /dev/null; then
    echo "âŒ GitHub CLI (gh) is not installed. Please install it first."
    echo "   brew install gh"
    return 1
  fi

  # Check if we're in a git repository
  if ! git rev-parse --git-dir &> /dev/null; then
    echo "âŒ Not in a git repository"
    return 1
  fi

  local prs selected_pr pr_number branch_name worktree_path

  # Get PR list with custom format: #number | title | author | head_branch
  echo "ğŸ” Fetching pull requests..."
  prs=$(gh pr list --state open --limit 50 --json number,title,author,headRefName --template '{{range .}}#{{.number}} | {{.title}} | @{{.author.login}} | {{.headRefName}}{{"\n"}}{{end}}')

  if [ -z "$prs" ]; then
    echo "ğŸ“­ No open pull requests found"
    return 0
  fi

  # Select PR using fzf
  selected_pr=$(echo "$prs" | fzf \
    --prompt="PRs > " \
    --header="Select a Pull Request to create worktree" \
    --preview="echo {} | cut -d'|' -f1 | sed 's/^#//' | xargs -I {} gh pr view {} --json title,author,body,headRefName,url --template 'Title: {{.title}}
Author: @{{.author.login}}
Branch: {{.headRefName}}
URL: {{.url}}

Description:
{{.body}}'" \
    --preview-window="right:60%" \
    --reverse \
    --border \
    --ansi \
    --delimiter="|" \
    --with-nth="1,2,3")

  if [ $? -ne 0 ]; then
    return 0
  fi

  if [ -n "$selected_pr" ]; then
    # Extract PR number and branch name
    pr_number=$(echo "$selected_pr" | cut -d'|' -f1 | sed 's/^#//' | tr -d ' ')
    branch_name=$(echo "$selected_pr" | cut -d'|' -f4 | tr -d ' ')
    
    # Get current project directory name and parent directory
    local git_root=$(git rev-parse --show-toplevel)
    local current_dir=$(basename "$git_root")
    local parent_dir=$(dirname "$git_root")
    local worktree_base_dir="${parent_dir}/${current_dir}.worktree"
    local default_path="${worktree_base_dir}/pr-${pr_number}-${branch_name}"
    
    # Ask for worktree path
    echo "Enter worktree path (default: ${default_path}):"
    read worktree_path
    
    # Use default if empty
    if [ -z "$worktree_path" ]; then
      worktree_path="$default_path"
    fi

    # Create worktree base directory if it doesn't exist
    local worktree_dir=$(dirname "$worktree_path")
    if [ ! -d "$worktree_dir" ]; then
      echo "ğŸ“ Creating worktree directory: $worktree_dir"
      mkdir -p "$worktree_dir"
    fi

    # Get PR details to fetch the branch safely
    echo "ğŸ“¥ Fetching PR branch..."
    local pr_details=$(gh pr view "$pr_number" --json isCrossRepository,headRepository,headRefName,headRepositoryOwner --template '{{.isCrossRepository}}:{{.headRepositoryOwner.login}}/{{.headRepository.name}}:{{.headRefName}}')
    
    if [ -z "$pr_details" ]; then
      echo "âŒ Failed to get PR details"
      return 1
    fi
    
    # Parse PR details
    local is_cross_repo=$(echo "$pr_details" | cut -d':' -f1)
    local head_repo=$(echo "$pr_details" | cut -d':' -f2)
    local head_branch=$(echo "$pr_details" | cut -d':' -f3)
    
    # Check if PR is from a fork or same repository
    if [[ "$is_cross_repo" == "true" ]]; then
      # Fork PR: add remote if it doesn't exist and fetch
      local remote_name="pr-${pr_number}-remote"
      local remote_url="https://github.com/${head_repo}.git"
      
      if ! git remote get-url "$remote_name" &> /dev/null; then
        echo "ğŸ”— Adding remote: $remote_name"
        git remote add "$remote_name" "$remote_url"
      fi
      
      echo "ğŸ“¦ Fetching from fork..."
      git fetch "$remote_name" "$head_branch"
      local full_branch_ref="${remote_name}/${head_branch}"
    else
      # Same repository PR: fetch the branch
      echo "ğŸ“¦ Fetching branch..."
      git fetch origin "$head_branch"
      local full_branch_ref="origin/${head_branch}"
    fi

    # Create the worktree with a local branch
    # Check if local branch already exists
    local local_branch_name="$head_branch"
    if git show-ref --verify --quiet "refs/heads/$local_branch_name"; then
      echo "ğŸ“Œ Local branch '$local_branch_name' already exists, using it"
      git worktree add "$worktree_path" "$local_branch_name"
    else
      echo "ğŸŒ¿ Creating local branch '$local_branch_name' from '$full_branch_ref'"
      git worktree add -b "$local_branch_name" "$worktree_path" "$full_branch_ref"
    fi
    
    if [ $? -eq 0 ]; then
      echo "âœ… Worktree created successfully: $worktree_path"
      echo "ğŸ”— PR #${pr_number}: $(echo "$selected_pr" | cut -d'|' -f2 | sed 's/^ *//')"
      
      # Copy .env and .mise.local.toml files from main repository
      local git_root=$(git rev-parse --show-toplevel)
      local config_files=$(find "$git_root" -maxdepth 3 \( -name ".env*" -o -name ".mise.local.toml" \) -type f 2>/dev/null)
      
      if [ -n "$config_files" ]; then
        echo ""
        echo "ğŸ“„ Found config files in main repository:"
        echo "$config_files" | while read config_file; do
          local rel_path=${config_file#$git_root/}
          echo "   $rel_path"
        done
        echo ""
        echo "ğŸ“‹ Copy config files to new worktree? [y/N]:"
        read -q copy_config
        echo ""
        
        if [[ "$copy_config" == "y" ]]; then
          echo "$config_files" | while read config_file; do
            local rel_path=${config_file#$git_root/}
            local target_file="$worktree_path/$rel_path"
            local target_dir=$(dirname "$target_file")
            
            # Create directory if it doesn't exist
            if [ ! -d "$target_dir" ]; then
              mkdir -p "$target_dir"
            fi
            
            # Copy file
            if cp "$config_file" "$target_file"; then
              echo "   âœ… Copied: $rel_path"
            else
              echo "   âŒ Failed to copy: $rel_path"
            fi
          done
        else
          echo "â­ï¸  Skipped copying config files"
        fi
      fi
      
      # Ask if user wants to open with VSCode
      echo "ğŸ’» Open with VSCode? [y/N]:"
      read -q open_vscode
      echo ""
      
      local should_cd=true
      if [[ "$open_vscode" == "y" ]]; then
        if command -v code &> /dev/null; then
          echo "ğŸš€ Opening VSCode..."
          code "$worktree_path"
          should_cd=false
        else
          echo "âŒ VSCode (code command) not found"
        fi
      fi
      
      # Navigate to the new worktree only if VSCode was not opened
      if [[ "$should_cd" == true ]]; then
        if zle; then
          # Called from ZLE (keyboard shortcut)
          BUFFER="cd ${worktree_path}"
          zle accept-line
        else
          # Called directly from command line
          cd "$worktree_path"
        fi
      fi
    else
      echo "âŒ Failed to create worktree"
      return 1
    fi
  fi

  # Only clear screen if ZLE is active
  if zle; then
    zle clear-screen
  fi
}

